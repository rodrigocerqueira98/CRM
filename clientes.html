<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clientes — Conecta CRM</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .client-detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
    .detail-field { background:var(--surface-2); border:1px solid var(--border); border-radius:var(--r-sm); padding:10px 12px; }
    .detail-field-label { font-size:10.5px; font-weight:600; color:var(--text-3); text-transform:uppercase; letter-spacing:.4px; margin-bottom:3px; }
    .detail-field-val { font-size:13.5px; font-weight:600; color:var(--text-1); }
  </style>
</head>
<body>
<script src="js/app.js"></script>
<script src="js/sidebar.js"></script>

<div class="main-wrap">
  <header class="topbar">
    <div class="topbar-title">Base de Clientes <span id="client-count"></span></div>
    <div class="topbar-actions">
      <div class="topbar-search">
        <i class="fa-solid fa-search search-icon"></i>
        <input type="text" id="search-input" placeholder="Nome, CNPJ, e-mail..." oninput="renderTable()">
      </div>
      <button class="btn btn-outline btn-sm" onclick="exportCSV()">
        <i class="fa-solid fa-download"></i> Exportar
      </button>
      <a href="clientes-cadastro.html" class="btn btn-primary">
        <i class="fa-solid fa-user-plus"></i> Novo Cliente
      </a>
    </div>
  </header>

  <div class="page-content">

    <!-- Filtros -->
    <div class="filter-bar card mb-16" style="border-radius:var(--r-lg);">
      <select class="filter-select" id="f-status" onchange="renderTable()">
        <option value="">Todos os status</option>
        <option value="active">Ativo</option>
        <option value="pending">Pendente</option>
        <option value="inactive">Inativo</option>
      </select>
      <select class="filter-select" id="f-type" onchange="renderTable()">
        <option value="">PF e PJ</option>
        <option value="pj">Pessoa Jurídica</option>
        <option value="pf">Pessoa Física</option>
      </select>
      <select class="filter-select" id="f-segment" onchange="renderTable()">
        <option value="">Todos os segmentos</option>
        <option value="enterprise">Enterprise</option>
        <option value="pme">PME</option>
        <option value="residencial">Residencial</option>
      </select>
      <select class="filter-select" id="f-plan" onchange="renderTable()">
        <option value="">Todos os planos</option>
        <optgroup label="Fibra">
          <option value="f200">Fibra 200M</option>
          <option value="f400">Fibra 400M</option>
          <option value="f1g">Fibra 1G</option>
        </optgroup>
        <optgroup label="Móvel">
          <option value="m15">Móvel 15GB</option>
          <option value="m40">Móvel 40GB</option>
          <option value="m100">Móvel 100GB</option>
        </optgroup>
        <optgroup label="Empresarial">
          <option value="b500">B2B 500M</option>
          <option value="b1g">B2B 1G</option>
          <option value="b10g">Datacenter 10G</option>
        </optgroup>
      </select>
      <button class="btn btn-ghost btn-sm" onclick="clearFilters()" style="margin-left:auto;">
        <i class="fa-solid fa-times"></i> Limpar
      </button>
    </div>

    <!-- Tabela -->
    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Documento</th>
              <th>Plano</th>
              <th>MRR</th>
              <th>Status</th>
              <th>Desde</th>
              <th>Responsável</th>
              <th class="td-center">Ações</th>
            </tr>
          </thead>
          <tbody id="client-table"></tbody>
        </table>
      </div>
      <div class="card-footer flex items-center justify-between">
        <span style="font-size:12.5px;color:var(--text-3);" id="table-info">Mostrando 0 clientes</span>
        <span style="font-size:12px;color:var(--text-3);">MRR total filtrado: <strong style="color:var(--text-1);font-family:var(--font-mono);" id="mrr-filtered">R$ 0</strong></span>
      </div>
    </div>

  </div>
</div>

<!-- Modal Detalhes -->
<div class="modal-overlay" id="modal-client">
  <div class="modal modal-lg">
    <div class="modal-header">
      <span class="modal-title" id="client-modal-title">Detalhes do Cliente</span>
      <button class="modal-close" onclick="Utils.modal('modal-client').close()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body" id="client-modal-body"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="Utils.modal('modal-client').close()">Fechar</button>
      <button class="btn btn-outline" onclick="Utils.toast('Abrindo funil...','info')">
        <i class="fa-solid fa-filter"></i> Ver no Funil
      </button>
      <button class="btn btn-primary" onclick="Utils.toast('Em desenvolvimento: edição de clientes','info')">
        <i class="fa-solid fa-pen"></i> Editar
      </button>
    </div>
  </div>
</div>

<script>
const user = initPage();

const planTypes = {
  f200:'fiber', f400:'fiber', f1g:'fiber',
  m15:'mobile', m40:'mobile', m100:'mobile',
  b500:'b2b', b1g:'b2b', b10g:'b2b'
};
const planTagClass = { fiber:'product-internet', mobile:'product-mobile', b2b:'product-b2b' };

function renderTable() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const fStatus = document.getElementById('f-status').value;
  const fType = document.getElementById('f-type').value;
  const fSeg = document.getElementById('f-segment').value;
  const fPlan = document.getElementById('f-plan').value;

  let list = Customers.list.filter(c => {
    if (q && !c.name.toLowerCase().includes(q) && !c.doc.includes(q) && !c.email.toLowerCase().includes(q)) return false;
    if (fStatus && c.status !== fStatus) return false;
    if (fType && c.type !== fType) return false;
    if (fSeg && c.segment !== fSeg) return false;
    if (fPlan && c.plan !== fPlan) return false;
    return true;
  });

  // Vendedor só vê seus clientes
  if (user.role === 'vendedor') list = list.filter(c => c.seller === user.id);

  const mrrTotal = list.reduce((s,c)=>s+c.mrr, 0);
  document.getElementById('table-info').textContent = `Mostrando ${list.length} cliente${list.length!==1?'s':''}`;
  document.getElementById('mrr-filtered').textContent = Utils.currency(mrrTotal, true);
  document.getElementById('client-count').textContent = `· ${list.length}`;

  const statusMap = {
    active:   ['Ativo',    'badge-success'],
    pending:  ['Pendente', 'badge-warning'],
    inactive: ['Inativo',  'badge-neutral'],
  };

  const tbody = document.getElementById('client-table');
  tbody.innerHTML = list.length === 0 ? `
    <tr><td colspan="8" style="text-align:center;padding:32px;color:var(--text-3);">
      <i class="fa-solid fa-search" style="font-size:24px;display:block;margin-bottom:8px;"></i>
      Nenhum cliente encontrado
    </td></tr>
  ` : list.map(c => {
    const seller = Utils.getUserById(c.seller);
    const [stLabel, stClass] = statusMap[c.status] || ['—','badge-neutral'];
    const planType = planTypes[c.plan] || 'fiber';
    const tagClass = planTagClass[planType] || 'product-internet';
    const planN = Utils.planName(c.plan);
    return `
      <tr>
        <td>
          <div style="display:flex;align-items:center;gap:9px;">
            <div class="avatar avatar-sm" style="background:${c.type==='pj'?'#1D4ED8':'#7C3AED'};font-size:9px;">${c.type==='pj'?'PJ':'PF'}</div>
            <div>
              <div style="font-size:13.5px;font-weight:600;color:var(--text-1);">${c.name}</div>
              <div style="font-size:11.5px;color:var(--text-3);">${c.email}</div>
            </div>
          </div>
        </td>
        <td class="mono" style="font-size:12px;">${c.doc}</td>
        <td><span class="product-tag ${tagClass}">${planN}</span></td>
        <td class="mono" style="font-size:13px;font-weight:700;color:var(--success);">${Utils.currency(c.mrr)}</td>
        <td><span class="badge ${stClass}">${stLabel}</span></td>
        <td style="font-size:12.5px;color:var(--text-3);">${new Date(c.since).toLocaleDateString('pt-BR')}</td>
        <td>
          <div style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--text-3);">
            <div class="avatar avatar-sm" style="background:${seller?.color}">${seller?.initials}</div>
            ${seller?.name?.split(' ')[0]}
          </div>
        </td>
        <td class="td-center">
          <div style="display:flex;gap:4px;justify-content:center;">
            <button class="btn btn-ghost btn-icon btn-xs" onclick="openDetail('${c.id}')" title="Ver detalhes">
              <i class="fa-solid fa-eye"></i>
            </button>
            <button class="btn btn-ghost btn-icon btn-xs" onclick="Utils.toast('Ligando para ${c.phone}...','info')" title="Ligar">
              <i class="fa-solid fa-phone"></i>
            </button>
            <button class="btn btn-ghost btn-icon btn-xs" onclick="toggleStatus('${c.id}')" title="Alterar status">
              <i class="fa-solid fa-toggle-on"></i>
            </button>
          </div>
        </td>
      </tr>`;
  }).join('');
}

function toggleStatus(id) {
  const c = Customers.list.find(x=>x.id===id);
  if (!c) return;
  const cycle = { active:'inactive', inactive:'pending', pending:'active' };
  c.status = cycle[c.status] || 'active';
  renderTable();
  Utils.toast(`Status alterado para: ${c.status}`, 'info');
}

function clearFilters() {
  ['f-status','f-type','f-segment','f-plan'].forEach(id => document.getElementById(id).value='');
  document.getElementById('search-input').value = '';
  renderTable();
}

function exportCSV() {
  const rows = [['Nome','Documento','Plano','MRR','Status','Desde','Responsável']];
  Customers.list.forEach(c => {
    const s = Utils.getUserById(c.seller);
    rows.push([c.name, c.doc, Utils.planName(c.plan), c.mrr, c.status, c.since, s?.name||'']);
  });
  const csv = rows.map(r => r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'clientes-conecta.csv';
  a.click();
  Utils.toast('Exportação concluída!', 'success');
}

function openDetail(id) {
  const c = Customers.list.find(x=>x.id===id);
  if (!c) return;
  const seller = Utils.getUserById(c.seller);
  const planN = Utils.planName(c.plan);
  const statusLabel = {active:'Ativo',pending:'Pendente',inactive:'Inativo'}[c.status];
  const statusClass = {active:'badge-success',pending:'badge-warning',inactive:'badge-neutral'}[c.status];
  const deals = Deals.list.filter(d => {
    const customer = Customers.list.find(x=>x.id===id);
    return d.company.toLowerCase().includes((customer?.name||'').split(' ')[0].toLowerCase());
  });

  document.getElementById('client-modal-title').textContent = c.name;
  document.getElementById('client-modal-body').innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;padding:14px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--r-md);">
      <div class="avatar avatar-lg" style="background:${c.type==='pj'?'#1D4ED8':'#7C3AED'};">${c.type==='pj'?'PJ':'PF'}</div>
      <div style="flex:1;">
        <h3 style="font-size:16px;font-weight:700;margin-bottom:2px;">${c.name}</h3>
        <div style="font-size:13px;color:var(--text-3);">${c.email} · ${c.phone}</div>
      </div>
      <span class="badge ${statusClass}">${statusLabel}</span>
    </div>

    <div class="client-detail-grid">
      ${[
        { label:'Documento', val: c.doc },
        { label:'Plano Ativo', val: planN },
        { label:'MRR', val: Utils.currency(c.mrr) },
        { label:'Segmento', val: {enterprise:'Enterprise',pme:'PME',residencial:'Residencial'}[c.segment] },
        { label:'Endereço', val: c.address },
        { label:'Cliente desde', val: new Date(c.since).toLocaleDateString('pt-BR') },
        { label:'Responsável', val: seller?.name || '—' },
      ].map(f=>`
        <div class="detail-field">
          <div class="detail-field-label">${f.label}</div>
          <div class="detail-field-val">${f.val}</div>
        </div>
      `).join('')}
    </div>

    ${deals.length > 0 ? `
      <div style="margin-top:14px;">
        <div style="font-size:12px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">Negócios Associados</div>
        ${deals.map(d=>`
          <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--r-sm);margin-bottom:6px;">
            <span style="font-size:13px;font-weight:600;flex:1;">${d.title}</span>
            <span class="badge badge-blue">${Deals.columns.find(c=>c.id===d.column)?.title}</span>
            <span style="font-size:12px;font-weight:700;color:var(--success);font-family:var(--font-mono);">${Utils.currency(d.value,true)}</span>
          </div>
        `).join('')}
      </div>
    ` : ''}
  `;
  Utils.modal('modal-client').open();
}

renderTable();
</script>
</body>
</html>
