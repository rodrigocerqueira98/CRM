<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financeiro — Conecta CRM</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
<script src="js/app.js"></script>
<script src="js/sidebar.js"></script>

<div class="main-wrap">
  <header class="topbar">
    <div class="topbar-title">Financeiro & Faturamento</div>
    <div class="topbar-actions">
      <button class="btn btn-outline btn-sm" onclick="Utils.toast('Fatura gerada!','success')">
        <i class="fa-solid fa-file-invoice"></i> Gerar Faturas
      </button>
      <button class="btn btn-primary btn-sm" onclick="Utils.toast('Exportando...','info')">
        <i class="fa-solid fa-download"></i> Exportar
      </button>
    </div>
  </header>

  <div class="page-content">

    <!-- KPIs -->
    <div class="kpi-grid mb-24" id="fin-kpis"></div>

    <!-- Gráfico MRR + tabela faturas -->
    <div class="grid-dash-wide mb-24" style="display:grid;grid-template-columns:1.4fr 1fr;gap:16px;">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Evolução MRR</span>
          <span class="badge badge-success"><i class="fa-solid fa-arrow-up"></i> +2.5% mês</span>
        </div>
        <div class="card-body"><canvas id="mrr-chart" height="180"></canvas></div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">Receita por Categoria</span>
        </div>
        <div class="card-body" id="revenue-cat"></div>
      </div>
    </div>

    <!-- Faturas -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Faturas <span id="inv-count"></span></span>
        <div style="display:flex;gap:6px;">
          <select class="filter-select" id="inv-filter" onchange="renderInvoices()">
            <option value="">Todas</option>
            <option value="open">Em aberto</option>
            <option value="paid">Pagas</option>
            <option value="overdue">Vencidas</option>
          </select>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Nº Fatura</th>
              <th>Cliente</th>
              <th>Plano</th>
              <th>Valor</th>
              <th>Vencimento</th>
              <th>Status</th>
              <th class="td-center">Ações</th>
            </tr>
          </thead>
          <tbody id="inv-table"></tbody>
        </table>
      </div>
      <div class="card-footer flex items-center justify-between">
        <span style="font-size:12.5px;color:var(--text-3);" id="inv-summary"></span>
        <span style="font-size:12px;color:var(--danger);font-weight:600;" id="overdue-summary"></span>
      </div>
    </div>

  </div>
</div>

<script>
const user = initPage();

// KPIs
document.getElementById('fin-kpis').innerHTML = [
  { icon:'fa-dollar-sign', color:'blue',   label:'MRR',           val: Utils.currency(Finance.mrr,true),     delta:'+8.3%', dir:'up' },
  { icon:'fa-calendar',    color:'green',  label:'ARR',           val: Utils.currency(Finance.arr,true),     delta:'Anualizado', dir:'neutral' },
  { icon:'fa-arrow-up',    color:'orange', label:'Novo MRR (Mês)',val: Utils.currency(Finance.newMrr,true),  delta:'+4 contratos', dir:'up' },
  { icon:'fa-arrow-down',  color:'red',    label:'MRR Perdido',   val: Utils.currency(Finance.churnedMrr,true), delta:`Churn: ${Finance.churn}%`, dir:'down' },
].map(k=>`
  <div class="kpi-card ${k.color}">
    <div class="kpi-top">
      <div class="kpi-icon ${k.color}"><i class="fa-solid ${k.icon}"></i></div>
      <span class="kpi-delta ${k.dir}">${k.delta}</span>
    </div>
    <div class="kpi-value">${k.val}</div>
    <div class="kpi-label">${k.label}</div>
  </div>
`).join('');

// MRR Chart
function drawMRR() {
  const canvas = document.getElementById('mrr-chart');
  const ctx = canvas.getContext('2d');
  const w = canvas.parentElement.offsetWidth - 40;
  const h = 180;
  const dpr = window.devicePixelRatio||1;
  canvas.width=w*dpr; canvas.height=h*dpr;
  canvas.style.width=w+'px'; canvas.style.height=h+'px';
  ctx.scale(dpr,dpr);

  const data = Finance.history;
  const vals = data.map(d=>d.mrr);
  const newVals = data.map(d=>d.new);
  const max = Math.max(...vals)*1.15;
  const pad = {l:55,r:16,t:12,b:26};
  const cw = w-pad.l-pad.r, ch = h-pad.t-pad.b;
  const step = cw/(data.length-1);

  // Gridlines
  [0,.25,.5,.75,1].forEach(f=>{
    const y = pad.t+ch*(1-f);
    ctx.strokeStyle='#E2E8F0'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+cw,y); ctx.stroke();
    ctx.fillStyle='#94A3B8'; ctx.font='10px Inter'; ctx.textAlign='right';
    ctx.fillText(Utils.currency(max*f,true), pad.l-4, y+4);
  });

  // MRR line
  const pts = vals.map((v,i)=>({x:pad.l+i*step, y:pad.t+ch*(1-v/max)}));
  const grad = ctx.createLinearGradient(0,pad.t,0,pad.t+ch);
  grad.addColorStop(0,'rgba(37,99,235,.18)'); grad.addColorStop(1,'rgba(37,99,235,0)');
  ctx.beginPath(); ctx.moveTo(pts[0].x,pad.t+ch);
  pts.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.lineTo(pts[pts.length-1].x,pad.t+ch);
  ctx.closePath(); ctx.fillStyle=grad; ctx.fill();

  ctx.beginPath(); ctx.strokeStyle='#2563EB'; ctx.lineWidth=2.5; ctx.lineJoin='round';
  pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y)); ctx.stroke();

  // Novo MRR bars
  const bw = 12;
  newVals.forEach((v,i)=>{
    const x = pad.l+i*step - bw/2;
    const bh = (v/max)*ch;
    ctx.fillStyle='rgba(5,150,105,.55)';
    ctx.fillRect(x, pad.t+ch-bh, bw, bh);
  });

  pts.forEach((p,i)=>{
    ctx.beginPath(); ctx.arc(p.x,p.y,4,0,Math.PI*2);
    ctx.fillStyle='#2563EB'; ctx.fill();
    ctx.beginPath(); ctx.arc(p.x,p.y,2.5,0,Math.PI*2);
    ctx.fillStyle='#fff'; ctx.fill();
    ctx.fillStyle='#64748B'; ctx.font='10px Inter'; ctx.textAlign='center';
    ctx.fillText(data[i].month, p.x, h-7);
  });

  // Legenda
  ctx.fillStyle='#2563EB'; ctx.fillRect(pad.l,6,12,6);
  ctx.fillStyle='#334155'; ctx.font='11px Inter'; ctx.textAlign='left';
  ctx.fillText('MRR Total', pad.l+15, 13);
  ctx.fillStyle='rgba(5,150,105,.6)'; ctx.fillRect(pad.l+90,6,12,6);
  ctx.fillStyle='#334155'; ctx.fillText('Novo MRR', pad.l+105, 13);
}
setTimeout(drawMRR, 80);

// Receita por categoria
document.getElementById('revenue-cat').innerHTML = [
  { label:'Fibra Residencial', mrr: Customers.list.filter(c=>['f200','f400','f1g'].includes(c.plan)).reduce((s,c)=>s+c.mrr,0), color:'#2563EB' },
  { label:'Internet Empresarial', mrr: Customers.list.filter(c=>['b500','b1g','b10g'].includes(c.plan)).reduce((s,c)=>s+c.mrr,0), color:'#D97706' },
  { label:'Linha Móvel', mrr: Customers.list.filter(c=>['m15','m40','m100'].includes(c.plan)).reduce((s,c)=>s+c.mrr,0), color:'#059669' },
].map(cat=>{
  const pct = Math.round(cat.mrr/Finance.mrr*100);
  return `
    <div style="padding:10px 0;border-bottom:1px solid var(--border);">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
        <span style="font-size:13px;font-weight:600;">${cat.label}</span>
        <span style="font-size:12px;font-family:var(--font-mono);font-weight:700;color:var(--text-1);">${Utils.currency(cat.mrr,true)}</span>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-track"><div class="progress-bar-fill" style="background:${cat.color};width:${pct}%;"></div></div>
        <span class="progress-val">${pct}%</span>
      </div>
    </div>`;
}).join('');

// Faturas
function renderInvoices() {
  const filter = document.getElementById('inv-filter').value;
  let list = [...Finance.invoices];
  if (filter) list = list.filter(i=>i.status===filter);

  const statusMap = { paid:['Pago','badge-success'], open:['Em aberto','badge-blue'], overdue:['Vencido','badge-danger'] };
  const total = list.reduce((s,i)=>s+i.value,0);
  const overdue = Finance.invoices.filter(i=>i.status==='overdue').reduce((s,i)=>s+i.value,0);

  document.getElementById('inv-count').textContent = `· ${list.length}`;
  document.getElementById('inv-summary').textContent = `${list.length} faturas · Total: ${Utils.currency(total,true)}`;
  document.getElementById('overdue-summary').textContent = overdue>0 ? `Vencidas: ${Utils.currency(overdue)}` : '';

  document.getElementById('inv-table').innerHTML = list.map(inv=>{
    const [stLabel, stClass] = statusMap[inv.status] || ['—','badge-neutral'];
    const isOverdue = inv.status==='overdue';
    return `
      <tr>
        <td class="mono" style="font-size:12px;">${inv.id}</td>
        <td style="font-size:13.5px;font-weight:500;">${inv.customer}</td>
        <td><span style="font-size:12px;color:var(--text-3);">${Utils.planName(inv.plan)}</span></td>
        <td class="mono" style="font-weight:700;color:${isOverdue?'var(--danger)':'var(--text-1)'};">${Utils.currency(inv.value)}</td>
        <td style="font-size:12.5px;color:${isOverdue?'var(--danger)':'var(--text-3)'};">${new Date(inv.due).toLocaleDateString('pt-BR')}</td>
        <td><span class="badge ${stClass}">${stLabel}</span></td>
        <td class="td-center">
          <div style="display:flex;gap:4px;justify-content:center;">
            <button class="btn btn-ghost btn-icon btn-xs" onclick="Utils.toast('Enviando boleto para o cliente...','info')" title="Enviar boleto">
              <i class="fa-solid fa-paper-plane"></i>
            </button>
            ${inv.status==='open'||inv.status==='overdue' ? `
              <button class="btn btn-ghost btn-icon btn-xs" onclick="markPaid('${inv.id}')" title="Marcar como pago" style="color:var(--success);">
                <i class="fa-solid fa-check"></i>
              </button>
            ` : ''}
          </div>
        </td>
      </tr>`;
  }).join('');
}

function markPaid(id) {
  const inv = Finance.invoices.find(i=>i.id===id);
  if (inv) inv.status = 'paid';
  renderInvoices();
  Utils.toast('Fatura marcada como paga!','success');
}

renderInvoices();
window.addEventListener('resize', Utils.debounce(drawMRR, 200));
</script>
</body>
</html>
